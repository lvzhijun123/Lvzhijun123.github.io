<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>四川省住宅二手房交易税费计算器（2026最新版）</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }
        body {
            background-color: #f5f7fa;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 48% 48%;
            gap: 4%;
        }
        .form-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.08);
        }
        .form-card h1 {
            font-size: 18px;
            color: #222;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        .step-module {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }
        .step-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        .step-tag {
            background: #007bff;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
        }
        .step-tag.required {
            background: #dc3545;
        }
        .step-tag.optional {
            background: #6c757d;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label.main-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        .form-group label.main-label .required-star {
            color: #dc3545;
            margin-left: 2px;
        }
        .form-group .desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .form-group .error-tip {
            font-size: 12px;
            color: #dc3545;
            margin-top: 4px;
            display: none;
        }
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        .radio-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            cursor: pointer;
        }
        input[type="radio"], input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-right: 5px;
            cursor: pointer;
        }
        input[type="number"], select {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        input[type="number"]:focus, select:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* 优化价格输入组布局 */
        .price-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .price-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            position: relative;
        }
        .price-input-wrapper input {
            flex: 1;
        }
        /* 单位样式 */
        .input-unit {
            position: absolute;
            right: 15px;
            bottom: 10px;
            font-size: 14px;
            color: #666;
            pointer-events: none;
        }
        .original-cost-wrapper {
            position: relative;
        }
        .uppercase-box {
            display: none; /* 隐藏大写显示框 */
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .btn-calculate {
            flex: 1;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-calculate:hover {
            background-color: #0056b3;
        }
        .btn-calculate:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .btn-reset {
            flex: 1;
            padding: 12px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-reset:hover {
            background-color: #5a6268;
        }
        .result-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.08);
            display: none;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .result-card h1 {
            font-size: 18px;
            color: #222;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        .summary-box {
            background-color: #00a854;
            border-radius: 6px;
            padding: 18px;
            color: white;
            margin-bottom: 25px;
        }
        .summary-title {
            text-align: center;
            font-size: 17px;
            font-weight: bold;
            margin-bottom: 12px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .tax-card {
            background-color: white;
            border-radius: 4px;
            padding: 12px;
            color: #333;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .tax-card.seller {
            border-top: 3px solid #e63946;
        }
        .tax-card.buyer {
            border-top: 3px solid #1976d2;
        }
        .tax-card h3 {
            text-align: center;
            font-size: 15px;
            margin-bottom: 8px;
            color: #e63946;
        }
        .tax-card.buyer h3 {
            color: #1976d2;
        }
        .tax-total {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin: 8px 0;
            color: #333;
        }
        .tax-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 13px;
            border-bottom: 1px dashed #eee;
        }
        .tax-item:last-child {
            border-bottom: none;
        }
        .total-tax-box {
            background-color: white;
            border-radius: 4px;
            padding: 15px;
            text-align: center;
            margin-top: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .total-tax-title {
            font-size: 15px;
            color: #666;
            margin-bottom: 8px;
        }
        .total-tax-amount {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .tip-box {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 8px;
            margin-top: 12px;
            font-size: 12px;
            color: #856404;
            text-align: center;
        }
        .policy-tip {
            background-color: #e8f4fd;
            border: 1px solid #b8daff;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #0c5460;
        }
        .calculation-step {
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            overflow: hidden;
        }
        .step-calc-header {
            background: #f8f9fa;
            padding: 10px 15px;
            font-weight: 600;
            font-size: 15px;
            color: #333;
            border-bottom: 1px solid #e9ecef;
        }
        .step-calc-content {
            padding: 15px;
            font-size: 13px;
            line-height: 1.8;
        }
        .calc-formula {
            background: #f8f9fa;
            padding: 8px 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-family: "Consolas", monospace;
        }
        .calc-detail-item {
            margin-bottom: 5px;
            color: #444;
        }
        .calc-highlight {
            color: #e63946;
            font-weight: 600;
        }
        .detail-title {
            font-size: 15px;
            font-weight: bold;
            margin: 20px 0 12px;
            color: #333;
            padding-bottom: 6px;
            border-bottom: 1px solid #eee;
        }
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 13px;
        }
        .detail-item .label {
            color: #555;
        }
        .detail-item .amount {
            font-weight: 600;
            color: #e63946;
        }
        .copy-btn {
            width: 100%;
            padding: 10px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 15px;
            transition: background 0.2s;
        }
        .copy-btn:hover {
            background-color: #218838;
        }
        .copy-tip {
            text-align: center;
            color: #28a745;
            margin-top: 8px;
            font-size: 12px;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .hidden-group {
            display: none;
            transition: all 0.3s ease;
        }
        /* 千分位格式化样式 */
        .number-format {
            font-variant-numeric: tabular-nums;
        }
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            .summary-grid {
                grid-template-columns: 1fr;
            }
            .step-module {
                padding: 12px;
            }
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
            .price-input-wrapper {
                flex-direction: column;
                align-items: stretch;
            }
            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-card">
            <h1>四川省住宅二手房交易税费计算器（2026最新版）</h1>
            
            <div class="step-module">
                <div class="step-header">
                    <div class="step-title">交易类型（步骤1/3）</div>
                    <div class="step-tag required">必填</div>
                </div>
                <div class="form-group">
                    <label class="main-label">交易类型<span class="required-star">*</span></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="tradeType" id="tradeTypeSale" checked>
                            <label for="tradeTypeSale">买卖</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="tradeType" id="tradeTypeGift">
                            <label for="tradeTypeGift">赠与</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="tradeType" id="tradeTypeInherit">
                            <label for="tradeTypeInherit">继承</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="tradeType" id="tradeTypeGiftSale">
                            <label for="tradeTypeGiftSale">赠与后再出售</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="tradeType" id="tradeTypeInheritSale">
                            <label for="tradeTypeInheritSale">继承后再出售</label>
                        </div>
                    </div>
                    <div class="desc">新增：赠与/继承取得房产后再次卖出，个税按差额20%征收</div>
                </div>

                <div class="form-group hidden-group" id="giftTypeGroup">
                    <label class="main-label">赠与关系<span class="required-star">*</span></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="giftRelation" id="giftDirect" checked>
                            <label for="giftDirect">直系亲属（父母/子女/配偶等）</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="giftRelation" id="giftIndirect">
                            <label for="giftIndirect">非直系亲属</label>
                        </div>
                    </div>
                </div>

                <div class="form-group hidden-group" id="inheritTypeGroup">
                    <label class="main-label">继承关系<span class="required-star">*</span></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="inheritRelation" id="inheritDirect" checked>
                            <label for="inheritDirect">法定继承人（配偶/子女/父母等）</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="inheritRelation" id="inheritIndirect">
                            <label for="inheritIndirect">非法定继承人</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="step-module">
                <div class="step-header">
                    <div class="step-title">基础信息（步骤2/3）</div>
                    <div class="step-tag required">必填</div>
                </div>
                
                <div class="form-group">
                    <label class="main-label">成交/评估价格（不含税）<span class="required-star">*</span></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="priceType" id="priceTypeTotal" checked>
                            <label for="priceTypeTotal">总价</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="priceType" id="priceTypeUnit">
                            <label for="priceTypeUnit">单价</label>
                        </div>
                    </div>
                    <div class="desc">统一使用不含税价格计税，价格需≥0</div>
                    <!-- 修复：简化价格输入组DOM结构，只保留一个输入容器 -->
                    <div class="price-input-group">
                        <div class="price-input-wrapper">
                            <!-- 总价输入框（默认显示） -->
                            <input type="number" id="transactionPriceTotal" placeholder="请输入总价（元），如：1000000" min="0" step="1" oninput="formatNumber(this);">
                            <span class="input-unit">元</span>
                        </div>
                        <div class="price-input-wrapper" style="display:none;" id="unitPriceWrapper">
                            <!-- 单价输入框（默认隐藏） -->
                            <input type="number" id="transactionPriceUnit" placeholder="请输入单价（元/㎡），如：10000" min="0" step="1" oninput="formatNumber(this);">
                            <span class="input-unit">元/㎡</span>
                        </div>
                    </div>
                    <div class="error-tip" id="priceError">请填写有效的价格（大于0）</div>
                </div>

                <!-- 原购房成本（仅赠与/继承后出售显示） -->
                <div class="form-group hidden-group" id="originalCostGroup">
                    <label class="main-label">原购房成本（不含税）<span class="required-star">*</span></label>
                    <div class="desc">赠与/继承前，房屋最初的购买价格（用于计算个税差额）</div>
                    <div class="original-cost-wrapper">
                        <input type="number" id="originalCost" placeholder="请输入原购房成本" min="0" step="1" oninput="formatNumber(this)">
                        <span class="input-unit">元</span>
                    </div>
                    <div class="error-tip" id="costError">请填写有效的原购房成本（大于0）</div>
                </div>

                <div class="form-group">
                    <label class="main-label">房产面积（㎡）<span class="required-star">*</span></label>
                    <div class="desc">区分≤140/＞140㎡（契税税率不同）</div>
                    <div class="price-input-wrapper">
                        <input type="number" id="houseArea" placeholder="如：140" min="0.01" step="0.01" oninput="formatNumber(this)">
                        <span class="input-unit">㎡</span>
                    </div>
                    <div class="error-tip" id="areaError">请填写有效的面积（大于0）</div>
                </div>

                <div class="form-group" id="holdingYearGroup">
                    <label class="main-label">持有年限（年）<span class="required-star">*</span></label>
                    <div class="desc">满2年免增值税，满5年+唯一免个税</div>
                    <div class="price-input-wrapper">
                        <input type="number" id="holdingYears" placeholder="如：5" min="0" step="0.01" oninput="formatNumber(this)">
                        <span class="input-unit">年</span>
                    </div>
                    <div class="error-tip" id="yearError">请填写有效的持有年限（≥0）</div>
                </div>

                <div class="form-group hidden-group" id="saleOptionGroup">
                    <label class="main-label">购房套数（买方）<span class="required-star">*</span></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="houseCount" id="houseFirst" checked>
                            <label for="houseFirst">首套</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="houseCount" id="houseSecond">
                            <label for="houseSecond">二套</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="houseCount" id="houseThird">
                            <label for="houseThird">三套及以上</label>
                        </div>
                    </div>
                </div>

                <div class="form-group" id="uniqueHouseGroup">
                    <label class="main-label">是否家庭唯一住房<span class="required-star">*</span></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="isUnique" id="isUniqueYes" checked>
                            <label for="isUniqueYes">是（满5年免征个税）</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="isUnique" id="isUniqueNo">
                            <label for="isUniqueNo">否</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="step-module">
                <div class="step-header">
                    <div class="step-title">其他设置（步骤3/3）</div>
                    <div class="step-tag optional">可选</div>
                </div>
                <div class="form-group">
                    <label class="main-label">城市维护建设税税率</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="cityTaxRate" id="cityRate7" value="0.07">
                            <label for="cityRate7">市区（7%）- 如成都主城区</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="cityTaxRate" id="cityRate5" value="0.05" checked>
                            <label for="cityRate5">县城、镇（5%）- 如绵阳江油市</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="cityTaxRate" id="cityRate1" value="0.01">
                            <label for="cityRate1">乡、其他地区（1%）- 如偏远乡镇</label>
                        </div>
                    </div>
                    <div class="policy-tip">政策依据：城建税=增值税×税率；教育费附加=增值税×3%；地方教育附加=增值税×2%</div>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn-calculate" id="calculateBtn" onclick="calculateTax()">计算税费</button>
                <button class="btn-reset" onclick="resetForm()">重置表单</button>
            </div>
        </div>

        <div class="result-card" id="resultCard">
            <h1>四川省住宅二手房税费计算结果（2026最新版）</h1>
            
            <div class="summary-box">
                <div class="summary-title">税费汇总</div>
                <div class="summary-grid">
                    <div class="tax-card seller">
                        <h3 id="sellerTitle">卖方税费</h3>
                        <div class="tax-total number-format" id="sellerTotalAmount">¥0.00</div>
                        <div class="tax-item">
                            <span>增值税</span>
                            <span class="number-format" id="vatAmount">¥0.00</span>
                        </div>
                        <div class="tax-item">
                            <span>城建税及附加</span>
                            <span class="number-format" id="cityTaxAddAmount">¥0.00</span>
                        </div>
                        <div class="tax-item">
                            <span>个人所得税</span>
                            <span class="number-format" id="sellerTaxAmount">¥0.00</span>
                        </div>
                        <div class="tax-item">
                            <span>印花税</span>
                            <span class="number-format" id="sellerStampAmount">¥0.00</span>
                        </div>
                    </div>
                    
                    <div class="tax-card buyer">
                        <h3 id="buyerTitle">买方税费</h3>
                        <div class="tax-total number-format" id="buyerTotalAmount">¥0.00</div>
                        <div class="tax-item">
                            <span>契税</span>
                            <span class="number-format" id="buyerTaxAmount">¥0.00</span>
                        </div>
                        <div class="tax-item">
                            <span>印花税</span>
                            <span class="number-format" id="buyerStampAmount">¥0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="total-tax-box">
                    <div class="total-tax-title">本次交易总税费</div>
                    <div class="total-tax-amount number-format" id="totalTaxAmount">¥0.00</div>
                </div>
                
                <div class="tip-box">
                    提示：1. 赠与/继承后再出售，个税按差额20%征收，仅满5唯一可免征；2. 个人住宅买卖免征印花税，赠与/继承需按0.05%征收；3. 契税政策依据《财政部 税务总局 住房城乡建设部2024年第16号公告》（延续至2026年）
                </div>
            </div>

            <div class="detail-title">一、基础信息</div>
            <div class="detail-item">
                <span class="label">交易类型：</span>
                <span id="detailTradeType">买卖</span>
            </div>
            <div class="detail-item">
                <span class="label">成交总价（不含税）：</span>
                <span class="number-format" id="detailTotalPrice">¥0.00</span>
            </div>
            <div class="detail-item" id="detailCost" style="display:none;">
                <span class="label">原购房成本：</span>
                <span class="number-format" id="detailOriginalCost">¥0.00</span>
            </div>
            <div class="detail-item">
                <span class="label">房产面积：</span>
                <span class="number-format" id="detailArea">0.00 ㎡</span>
            </div>
            <div class="detail-item">
                <span class="label">持有年限：</span>
                <span class="number-format" id="detailHoldingYears">0.00 年</span>
            </div>
            <div class="detail-item" id="detailHouseCount" style="display:none;">
                <span class="label">买方购房套数：</span>
                <span id="detailHouseCountText">首套</span>
            </div>

            <div class="calculation-step">
                <div class="step-calc-header">1. 核心税费计算逻辑（2026四川最新政策）</div>
                <div class="step-calc-content" id="calcContent">
                    <div class="calc-formula">请先完成计算</div>
                </div>
            </div>

            <button class="copy-btn" onclick="copyResult()">复制完整计算结果</button>
            <div class="copy-tip" id="copyTip">✓ 结果已复制到剪贴板！</div>
        </div>
    </div>

    <script>
        // 缓存DOM元素
        const DOM = {
            tradeTypeRadios: document.querySelectorAll('input[name="tradeType"]'),
            priceTypeTotal: document.getElementById('priceTypeTotal'),
            priceTypeUnit: document.getElementById('priceTypeUnit'),
            transactionPriceTotal: document.getElementById('transactionPriceTotal'),
            transactionPriceUnit: document.getElementById('transactionPriceUnit'),
            unitPriceWrapper: document.getElementById('unitPriceWrapper'),
            originalCost: document.getElementById('originalCost'),
            houseArea: document.getElementById('houseArea'),
            holdingYears: document.getElementById('holdingYears'),
            calculateBtn: document.getElementById('calculateBtn'),
            resultCard: document.getElementById('resultCard'),
            copyTip: document.getElementById('copyTip'),
            // 错误提示
            priceError: document.getElementById('priceError'),
            areaError: document.getElementById('areaError'),
            yearError: document.getElementById('yearError'),
            costError: document.getElementById('costError')
        };

        // 千分位格式化
        function formatNumber(input) {
            if (!input.value) return;
            // 清除非数字字符（保留小数点后两位）
            let value = input.value.replace(/[^\d.]/g, '');
            const dotIndex = value.indexOf('.');
            if (dotIndex > -1) {
                value = value.substring(0, dotIndex + 3);
            }
            input.value = value;
            
            // 千分位格式化（仅显示用，实际计算用原始值）
            return parseFloat(value) || 0;
        }

        // 交易类型切换逻辑
        function initTradeTypeSwitch() {
            DOM.tradeTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const tradeType = this.id;
                    // 重置所有隐藏组
                    document.getElementById('giftTypeGroup').classList.add('hidden-group');
                    document.getElementById('inheritTypeGroup').classList.add('hidden-group');
                    document.getElementById('saleOptionGroup').classList.add('hidden-group');
                    document.getElementById('originalCostGroup').classList.add('hidden-group');
                    document.getElementById('holdingYearGroup').style.display = 'block';
                    document.getElementById('detailCost').style.display = 'none';
                    document.getElementById('detailHouseCount').style.display = 'none';

                    // 重置标题
                    document.getElementById('sellerTitle').innerText = '卖方税费';
                    document.getElementById('buyerTitle').innerText = '买方税费';

                    // 按交易类型显示对应项
                    switch(tradeType) {
                        case 'tradeTypeGift':
                            document.getElementById('giftTypeGroup').classList.remove('hidden-group');
                            document.getElementById('sellerTitle').innerText = '赠与人税费';
                            document.getElementById('buyerTitle').innerText = '受赠人税费';
                            break;
                        case 'tradeTypeInherit':
                            document.getElementById('inheritTypeGroup').classList.remove('hidden-group');
                            document.getElementById('holdingYearGroup').style.display = 'none';
                            document.getElementById('sellerTitle').innerText = '被继承人税费';
                            document.getElementById('buyerTitle').innerText = '继承人税费';
                            break;
                        case 'tradeTypeGiftSale':
                        case 'tradeTypeInheritSale':
                            document.getElementById('originalCostGroup').classList.remove('hidden-group');
                            document.getElementById('saleOptionGroup').classList.remove('hidden-group');
                            document.getElementById('detailCost').style.display = 'flex';
                            document.getElementById('detailHouseCount').style.display = 'flex';
                            break;
                        default: // 普通买卖
                            document.getElementById('saleOptionGroup').classList.remove('hidden-group');
                            document.getElementById('detailHouseCount').style.display = 'flex';
                            break;
                    }
                });
            });
        }

        // 价格类型切换（修复：仅切换显示/隐藏，不重新创建DOM）
        function initPriceTypeSwitch() {
            DOM.priceTypeTotal.addEventListener('change', function() {
                DOM.transactionPriceTotal.parentElement.style.display = 'block';
                DOM.unitPriceWrapper.style.display = 'none';
            });
            DOM.priceTypeUnit.addEventListener('change', function() {
                DOM.transactionPriceTotal.parentElement.style.display = 'none';
                DOM.unitPriceWrapper.style.display = 'block';
            });
        }

        // 表单验证
        function validateForm(tradeType) {
            let isValid = true;
            // 隐藏所有错误提示
            DOM.priceError.style.display = 'none';
            DOM.areaError.style.display = 'none';
            DOM.yearError.style.display = 'none';
            DOM.costError.style.display = 'none';

            // 价格验证
            let price = 0;
            if (DOM.priceTypeTotal.checked) {
                price = parseFloat(DOM.transactionPriceTotal.value) || 0;
            } else {
                const unitPrice = parseFloat(DOM.transactionPriceUnit.value) || 0;
                const area = parseFloat(DOM.houseArea.value) || 0;
                price = unitPrice * area;
            }
            if (price <= 0) {
                DOM.priceError.style.display = 'block';
                isValid = false;
            }

            // 面积验证
            const area = parseFloat(DOM.houseArea.value) || 0;
            if (area <= 0) {
                DOM.areaError.style.display = 'block';
                isValid = false;
            }

            // 持有年限验证（继承除外）
            if (tradeType !== 'tradeTypeInherit') {
                const years = parseFloat(DOM.holdingYears.value) || 0;
                if (years < 0) {
                    DOM.yearError.style.display = 'block';
                    isValid = false;
                }
            }

            // 原购房成本验证（赠与/继承后出售）
            if (tradeType === 'tradeTypeGiftSale' || tradeType === 'tradeTypeInheritSale') {
                const originalCost = parseFloat(DOM.originalCost.value) || 0;
                if (originalCost <= 0) {
                    DOM.costError.style.display = 'block';
                    isValid = false;
                }
            }

            return { isValid, price, area, years: parseFloat(DOM.holdingYears.value) || 0 };
        }

        // 核心税费计算
        function calculateTax() {
            // 禁用计算按钮，防止重复点击
            DOM.calculateBtn.disabled = true;
            DOM.calculateBtn.innerText = '计算中...';

            // 获取基础参数
            const tradeType = document.querySelector('input[name="tradeType"]:checked').id;
            const isUnique = document.getElementById('isUniqueYes').checked;
            const cityRate = parseFloat(document.querySelector('input[name="cityTaxRate"]:checked').value);
            const originalCost = parseFloat(DOM.originalCost.value) || 0;
            const houseCount = document.querySelector('input[name="houseCount"]:checked')?.id || 'houseFirst';
            
            // 表单验证
            const { isValid, price, area, years } = validateForm(tradeType);
            if (!isValid) {
                DOM.calculateBtn.disabled = false;
                DOM.calculateBtn.innerText = '计算税费';
                return;
            }

            // 初始化税费
            let vat = 0, cityAdd = 0, deedTax = 0, sellerTax = 0;
            let sellerStamp = 0, buyerStamp = 0;
            let logic = '', tradeName = '';

            // ========== 1. 普通买卖 ==========
            if (tradeType === 'tradeTypeSale') {
                tradeName = '普通买卖';
                // 增值税：满2年免征，不满2年按5%
                if (years < 2) {
                    vat = price * 0.05;
                    cityAdd = vat * (cityRate + 0.03 + 0.02); // 城建税+教育费附加+地方教育附加
                    logic += `• 增值税：不满2年 = ${formatMoney(price)} × 5% = ${formatMoney(vat)}<br>`;
                    logic += `• 城建税及附加：${formatMoney(vat)} × (${(cityRate*100)}%+3%+2%) = ${formatMoney(cityAdd)}<br>`;
                } else {
                    logic += `• 增值税：满2年，免征<br>• 城建税及附加：免征<br>`;
                }

                // 契税（2026四川最新政策 - 依据财政部 税务总局 住房城乡建设部2024年第16号公告）
                let deedTaxRate = 0;
                let deedTaxDesc = '';
                if (houseCount === 'houseFirst') {
                    // 核心修改：首套房以140㎡为界限，140㎡及以下1%，140㎡以上1.5%
                    deedTaxRate = area <= 140 ? 0.01 : 0.015;
                    deedTaxDesc = `首套${area}㎡（≤140㎡按1%，>140㎡按1.5%）`;
                } else if (houseCount === 'houseSecond') {
                    // 核心修改：二套房以140㎡为界限，140㎡及以下1%，140㎡以上2%
                    deedTaxRate = area <= 140 ? 0.01 : 0.02;
                    deedTaxDesc = `二套${area}㎡（≤140㎡按1%，>140㎡按2%）`;
                } else { // 三套及以上
                    // 三套及以上：统一3%
                    deedTaxRate = 0.03;
                    deedTaxDesc = `三套及以上${area}㎡（统一按3%）`;
                }
                deedTax = price * deedTaxRate;
                logic += `• 契税：${deedTaxDesc} = ${formatMoney(price)} × ${(deedTaxRate*100)}% = ${formatMoney(deedTax)}<br>`;

                // 个税：满5唯一免征，否则按1%
                if (isUnique && years >= 5) {
                    sellerTax = 0;
                    logic += `• 个税：满5年且家庭唯一住房，免征<br>`;
                } else {
                    sellerTax = price * 0.01;
                    logic += `• 个税：不满5年/非唯一 = ${formatMoney(price)} × 1% = ${formatMoney(sellerTax)}<br>`;
                }

                // 印花税：个人住宅买卖免征
                sellerStamp = 0;
                buyerStamp = 0;
                logic += `• 印花税：个人住宅买卖，免征<br>`;
            }

            // ========== 2. 赠与后再出售 / 继承后再出售 ==========
            else if (tradeType === 'tradeTypeGiftSale' || tradeType === 'tradeTypeInheritSale') {
                tradeName = tradeType === 'tradeTypeGiftSale' ? '赠与后再出售' : '继承后再出售';
                // 增值税：同普通买卖
                if (years < 2) {
                    vat = price * 0.05;
                    cityAdd = vat * (cityRate + 0.03 + 0.02);
                    logic += `• 增值税：不满2年 = ${formatMoney(price)} × 5% = ${formatMoney(vat)}<br>`;
                    logic += `• 城建税及附加：${formatMoney(vat)} × (${(cityRate*100)}%+3%+2%) = ${formatMoney(cityAdd)}<br>`;
                } else {
                    logic += `• 增值税：满2年，免征<br>• 城建税及附加：免征<br>`;
                }

                // 契税（2026四川最新政策）
                let deedTaxRate = 0;
                let deedTaxDesc = '';
                if (houseCount === 'houseFirst') {
                    // 核心修改：首套房以140㎡为界限
                    deedTaxRate = area <= 140 ? 0.01 : 0.015;
                    deedTaxDesc = `首套${area}㎡（≤140㎡按1%，>140㎡按1.5%）`;
                } else if (houseCount === 'houseSecond') {
                    // 核心修改：二套房以140㎡为界限
                    deedTaxRate = area <= 140 ? 0.01 : 0.02;
                    deedTaxDesc = `二套${area}㎡（≤140㎡按1%，>140㎡按2%）`;
                } else {
                    // 三套及以上：统一3%
                    deedTaxRate = 0.03;
                    deedTaxDesc = `三套及以上${area}㎡（统一按3%）`;
                }
                deedTax = price * deedTaxRate;
                logic += `• 契税：${deedTaxDesc} = ${formatMoney(price)} × ${(deedTaxRate*100)}% = ${formatMoney(deedTax)}<br>`;

                // 个税：差额20% / 满5唯一免征
                if (isUnique && years >= 5) {
                    sellerTax = 0;
                    logic += `• 个税：满5年且家庭唯一住房，免征<br>`;
                } else {
                    const gap = Math.max(price - originalCost, 0);
                    sellerTax = gap * 0.2;
                    logic += `• 个税：差额20% = (${formatMoney(price)} - ${formatMoney(originalCost)}) × 20% = ${formatMoney(sellerTax)}<br>`;
                }

                // 印花税：免征
                sellerStamp = 0;
                buyerStamp = 0;
            }

            // ========== 3. 直接赠与 ==========
            else if (tradeType === 'tradeTypeGift') {
                tradeName = '直接赠与';
                const isDirect = document.getElementById('giftDirect').checked;
                
                // 增值税：直系亲属赠与免征，非直系按买卖
                if (isDirect) {
                    vat = 0;
                    cityAdd = 0;
                    logic += `• 增值税：直系亲属赠与，免征<br>• 城建税及附加：免征<br>`;
                } else {
                    vat = price * 0.05;
                    cityAdd = vat * (cityRate + 0.03 + 0.02);
                    logic += `• 增值税：非直系亲属赠与 = ${formatMoney(price)} × 5% = ${formatMoney(vat)}<br>`;
                    logic += `• 城建税及附加：${formatMoney(vat)} × (${(cityRate*100)}%+3%+2%) = ${formatMoney(cityAdd)}<br>`;
                }

                // 契税：直系/非直系均按3%
                deedTax = price * 0.03;
                logic += `• 契税：赠与按3%征收 = ${formatMoney(price)} × 3% = ${formatMoney(deedTax)}<br>`;

                // 个税：直系免征，非直系按偶然所得20%（调整为卖方/赠与人税费）
                if (isDirect) {
                    logic += `• 个税：直系亲属赠与，免征<br>`;
                } else {
                    sellerTax = price * 0.2; // 调整为卖方税费
                    logic += `• 个税：非直系亲属赠与（偶然所得）= ${formatMoney(price)} × 20% = ${formatMoney(sellerTax)}<br>`;
                }

                // 印花税：双方各0.05%
                sellerStamp = price * 0.0005;
                buyerStamp = price * 0.0005;
                logic += `• 印花税：双方各0.05% = ${formatMoney(price)} × 0.05% = ${formatMoney(sellerStamp)}（赠与人）+ ${formatMoney(buyerStamp)}（受赠人）<br>`;
            }

            // ========== 4. 直接继承 ==========
            else if (tradeType === 'tradeTypeInherit') {
                tradeName = '直接继承';
                const isDirect = document.getElementById('inheritDirect').checked;
                
                // 增值税、个税、契税：法定继承免征
                if (isDirect) {
                    vat = 0;
                    cityAdd = 0;
                    deedTax = 0;
                    logic += `• 增值税：法定继承，免征<br>• 城建税及附加：免征<br>• 契税：法定继承，免征<br>• 个税：法定继承，免征<br>`;
                } else {
                    // 非法定继承按赠与处理（个税调整为卖方税费）
                    deedTax = price * 0.03;
                    sellerTax = price * 0.2;
                    logic += `• 契税：非法定继承按赠与3% = ${formatMoney(price)} × 3% = ${formatMoney(deedTax)}<br>`;
                    logic += `• 个税：非法定继承（偶然所得）= ${formatMoney(price)} × 20% = ${formatMoney(sellerTax)}<br>`;
                }

                // 印花税：继承按0.05%（法定继承可减免）
                sellerStamp = isDirect ? 0 : price * 0.0005;
                buyerStamp = isDirect ? 0 : price * 0.0005;
                logic += `• 印花税：${isDirect ? '法定继承，免征' : `非法定继承按0.05% = ${formatMoney(price)} × 0.05% = ${formatMoney(buyerStamp)}`}<br>`;
            }

            // ========== 汇总计算 ==========
            const sellerTotal = parseFloat((vat + cityAdd + sellerTax + sellerStamp).toFixed(2));
            const buyerTotal = parseFloat((deedTax + buyerStamp).toFixed(2));
            const total = parseFloat((sellerTotal + buyerTotal).toFixed(2));

            // ========== 渲染结果 ==========
            // 基础信息
            document.getElementById('detailTradeType').innerText = tradeName;
            document.getElementById('detailTotalPrice').innerText = formatMoney(price);
            document.getElementById('detailOriginalCost').innerText = formatMoney(originalCost);
            document.getElementById('detailArea').innerText = `${area.toFixed(2)} ㎡`;
            document.getElementById('detailHoldingYears').innerText = `${years.toFixed(2)} 年`;
            document.getElementById('detailHouseCountText').innerText = houseCount === 'houseFirst' ? '首套' : houseCount === 'houseSecond' ? '二套' : '三套及以上';

            // 税费明细
            document.getElementById('vatAmount').innerText = formatMoney(vat);
            document.getElementById('cityTaxAddAmount').innerText = formatMoney(cityAdd);
            document.getElementById('sellerTaxAmount').innerText = formatMoney(sellerTax);
            document.getElementById('buyerTaxAmount').innerText = formatMoney(deedTax);
            document.getElementById('sellerStampAmount').innerText = formatMoney(sellerStamp);
            document.getElementById('buyerStampAmount').innerText = formatMoney(buyerStamp);

            // 总计
            document.getElementById('sellerTotalAmount').innerText = formatMoney(sellerTotal);
            document.getElementById('buyerTotalAmount').innerText = formatMoney(buyerTotal);
            document.getElementById('totalTaxAmount').innerText = formatMoney(total);

            // 计算逻辑
            document.getElementById('calcContent').innerHTML = `<div class="calc-formula">${tradeName}计税规则（2026四川）</div>${logic}`;

            // 显示结果
            DOM.resultCard.style.display = 'block';

            // 恢复按钮状态
            DOM.calculateBtn.disabled = false;
            DOM.calculateBtn.innerText = '计算税费';
        }

        // 格式化金额显示（千分位 + 人民币符号）
        function formatMoney(num) {
            if (!num || num <= 0) return '¥0.00';
            return '¥' + parseFloat(num).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // 复制结果到剪贴板
        function copyResult() {
            const resultCard = document.getElementById('resultCard');
            const textContent = [
                `交易类型：${document.getElementById('detailTradeType').innerText}`,
                `成交总价：${document.getElementById('detailTotalPrice').innerText}`,
                `房产面积：${document.getElementById('detailArea').innerText}`,
                `持有年限：${document.getElementById('detailHoldingYears').innerText}`,
                `卖方总税费：${document.getElementById('sellerTotalAmount').innerText}`,
                `买方总税费：${document.getElementById('buyerTotalAmount').innerText}`,
                `交易总税费：${document.getElementById('totalTaxAmount').innerText}`,
                `计算逻辑：${document.getElementById('calcContent').innerText.replace(/<br>/g, '\n').replace(/<[^>]+>/g, '')}`
            ].join('\n');

            // 复制到剪贴板
            navigator.clipboard.writeText(textContent).then(() => {
                DOM.copyTip.style.display = 'block';
                setTimeout(() => {
                    DOM.copyTip.style.display = 'none';
                }, 2000);
            }).catch(err => {
                alert('复制失败，请手动复制：' + textContent);
            });
        }

        // 重置表单
        function resetForm() {
            // 重置输入框
            DOM.transactionPriceTotal.value = '';
            DOM.transactionPriceUnit.value = '';
            DOM.originalCost.value = '';
            DOM.houseArea.value = '';
            DOM.holdingYears.value = '';
            
            // 重置单选框
            document.getElementById('tradeTypeSale').checked = true;
            document.getElementById('priceTypeTotal').checked = true;
            document.getElementById('isUniqueYes').checked = true;
            document.getElementById('cityRate5').checked = true;
            document.getElementById('houseFirst').checked = true;
            
            // 重置隐藏组
            document.getElementById('giftTypeGroup').classList.add('hidden-group');
            document.getElementById('inheritTypeGroup').classList.add('hidden-group');
            document.getElementById('saleOptionGroup').classList.add('hidden-group');
            document.getElementById('originalCostGroup').classList.add('hidden-group');
            document.getElementById('holdingYearGroup').style.display = 'block';
            
            // 重置结果
            DOM.resultCard.style.display = 'none';
            DOM.copyTip.style.display = 'none';
            
            // 隐藏错误提示
            DOM.priceError.style.display = 'none';
            DOM.areaError.style.display = 'none';
            DOM.yearError.style.display = 'none';
            DOM.costError.style.display = 'none';
            
            // 重置价格输入框显示状态
            DOM.transactionPriceTotal.parentElement.style.display = 'block';
            DOM.unitPriceWrapper.style.display = 'none';
        }

        // 初始化
        window.onload = function() {
            initTradeTypeSwitch();
            initPriceTypeSwitch();
        };
    </script>
</body>
</html>
